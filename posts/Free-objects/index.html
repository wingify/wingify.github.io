<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.722 'Lato',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Lato',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;color:hsla(0,0%,0%,0.9);font-family:'Neuton',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}ul{margin-left:1.722rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.722rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;font-size:0.85rem;line-height:1.722rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;font-size:1rem;line-height:1.722rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}blockquote{margin-left:0;margin-right:1.722rem;margin-top:0;padding-bottom:0;padding-left:1.93725rem;padding-right:0;padding-top:0;margin-bottom:1.722rem;font-size:1.1487rem;line-height:1.722rem;color:hsla(0,0%,0%,0.59);border-left:0.64575rem solid;border-color:#612423;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.722rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.722rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.722rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.722rem;margin-bottom:calc(1.722rem / 2);margin-top:calc(1.722rem / 2);}li > ul{margin-left:1.722rem;margin-bottom:calc(1.722rem / 2);margin-top:calc(1.722rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.722rem / 2);}code{font-size:0.85rem;line-height:1.722rem;}kbd{font-size:0.85rem;line-height:1.722rem;}samp{font-size:0.85rem;line-height:1.722rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.148rem;padding-right:1.148rem;padding-top:0.861rem;padding-bottom:calc(0.861rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#4665b7;text-decoration:none;}a:hover,a:active{color:hsla(0,0%,0%,0.8);}h1,h2,h3,h4,h5,h6{margin-top:3.444rem;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.722rem;color:hsla(0,0%,0%,0.8);font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){blockquote{margin-left:-1.2915rem;margin-right:0;border-left:0.32288rem solid;border-color:#612423;padding-left:0.96862rem;}}</style><style data-href="/styles.43141b4598df0c2f6d03.css">footer{background-color:rgba(0,0,0,.9);padding:20px 0 40px;color:hsla(0,0%,100%,.7)}footer .Footer-module--container--3Dvn1{display:grid;grid-template-columns:50% 50%;margin-left:auto;margin-right:auto;max-width:50rem;padding:20px}footer a{color:#ddd;margin:10px}footer a:hover{color:#fff}footer .Footer-module--copyright--2uglW{text-align:right}header{display:flex;justify-content:space-between;align-items:center;padding:1rem;position:-webkit-sticky;position:sticky;top:0;background:hsla(0,0%,100%,.75);-webkit-backdrop-filter:blur(7px);backdrop-filter:blur(7px);z-index:9;margin-left:auto;margin-right:auto;height:70px}header a{text-decoration:none;color:#3c4856;font-size:1.1rem;margin-top:0}header h1{margin-top:5px}header nav a{color:#757575;transition:color .2s ease;text-decoration:none;display:inline-block;position:relative;font-size:16px}header nav a:hover{color:#4f647d}header nav a strong{margin:1px;color:#4f647d;font-size:.8rem}header .Header-module--activeNav--25noA{color:#4f647d;font-weight:700}.Header-module--brand--nQIOf{margin-top:40px;display:flex;flex-direction:row;flex-wrap:wrap}.Header-module--main-nav--2C0n8{display:flex;list-style:none;padding:0;margin-top:30px;overflow:auto;overflow:-moz-scrollbars-none;scrollbar-width:none;-ms-overflow-style:none!important}.Header-module--main-nav--2C0n8::-webkit-scrollbar{width:0!important}.Header-module--main-nav--2C0n8 li{font-size:1.3rem}.Header-module--main-nav--2C0n8 li+li{margin-left:1.5rem}@media (max-width:1000px){header{display:block;height:120px}.Header-module--brand--nQIOf{margin-top:0;margin-bottom:0}nav{margin-top:-50px}nav ul{margin:0}}@media (max-width:768px){header strong{display:none}.Header-module--main-nav--2C0n8 li+li{margin-left:1rem}}@media (max-width:520px){header nav a{font-size:.7rem;border:1px solid #eee;padding:2px;border-radius:5px}}body{margin:0;background:#fafbfb}h1,h2,h3,h4,h5,h6{margin-top:1rem}main{margin-left:auto;margin-right:auto;max-width:50rem;display:flex;flex-direction:column;min-height:100vh;padding:20px}article{height:90%}article:hover{box-shadow:0 11px 22px 12px #eee;border-radius:5px}.PostsListing-module--article-list--3ReSK{display:grid;grid-template-columns:50% 50%}.PostsListing-module--article-list--3ReSK .PostsListing-module--article-box--3M6_I{margin-bottom:30px;display:inline-block;width:auto;transition:all .25s ease}.PostsListing-module--article-list--3ReSK .PostsListing-module--article-box--3M6_I:hover{cursor:pointer}.PostsListing-module--article-list--3ReSK .PostsListing-module--article-box--3M6_I .PostsListing-module--right--2MxCO{padding:15px;color:#3c4856;margin-top:-20px}.PostsListing-module--article-list--3ReSK .PostsListing-module--article-box--3M6_I .PostsListing-module--right--2MxCO .PostsListing-module--meta--3cFzL{margin-top:-15px;margin-bottom:20px;font-size:.7rem}@media (max-width:768px){.PostsListing-module--article-list--3ReSK{grid-template-columns:100%}}.pill{display:inline-block;height:24px;padding:0 10px;margin-left:5px;margin-right:5px;margin-bottom:10px;color:#929fb3;text-transform:uppercase;font-size:12px;line-height:22px;border-radius:2px;border:1px solid}.projects{text-align:center}.project-box{float:left;width:50%;padding:20px}@media (max-width:600px){.project-box{width:100%}}.Bio-module--avatar--v_AB0{border-radius:50%;width:70px;float:left;margin:5px 20px}.PostTags-module--tag-container--ksSgQ a{text-decoration:none;display:inline-grid}.PostTags-module--tag-container--ksSgQ span{font-size:.8rem;font-weight:500;padding:.3rem .6rem;margin:.3rem;border-radius:3px;background:rgba(141,154,169,.21);color:rgba(0,0,0,.54)}.SocialLinks-module--social-links--1RDpJ{position:fixed;top:100px;left:30px;flex-direction:row;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center;margin:15px 0}.SocialLinks-module--social-links--1RDpJ div{margin:5px 15px;cursor:pointer}.SocialLinks-module--share-count--3wXKp{text-align:center}@media (max-width:1200px){.SocialLinks-module--social-links--1RDpJ{position:relative;top:0}.SocialLinks-module--social-links--1RDpJ div{display:inline-grid;position:relative}}.post-module--post-meta--1ci95{color:#757575;margin-bottom:.5rem;font-size:.7rem}.post-module--pagination--1F-V0{display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;margin-top:4rem}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><title data-react-helmet="true">Free objects - a generalized interpreter pattern | Wingify Engineering</title><link data-react-helmet="true" rel="icon" type="image/png" href="/images/favicon.png"/><meta data-react-helmet="true" name="description" content="In the GOF book, the interpreter pattern is probably one of the most poorly described patterns. The interpreter pattern basically consists…"/><meta data-react-helmet="true" name="image" content=""/><meta data-react-helmet="true" property="og:url" content="https://engineering.wingify.com//posts/Free-objects/"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Free objects - a generalized interpreter pattern"/><meta data-react-helmet="true" property="og:description" content="In the GOF book, the interpreter pattern is probably one of the most poorly described patterns. The interpreter pattern basically consists…"/><meta data-react-helmet="true" property="og:image" content=""/><meta data-react-helmet="true" property="fb:app_id" content=""/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="wingify_engg"/><meta data-react-helmet="true" name="twitter:title" content="Free objects - a generalized interpreter pattern"/><meta data-react-helmet="true" name="twitter:description" content="In the GOF book, the interpreter pattern is probably one of the most poorly described patterns. The interpreter pattern basically consists…"/><meta data-react-helmet="true" name="twitter:image" content=""/><script data-react-helmet="true" type="application/ld+json">[{"@context":"http://schema.org","@type":"WebSite","url":"https://engineering.wingify.com/","name":"Free objects - a generalized interpreter pattern","alternateName":"Wingify Engineering - Blog"},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://engineering.wingify.com//posts/Free-objects/","name":"Free objects - a generalized interpreter pattern","image":""}}]},{"@context":"http://schema.org","@type":"BlogPosting","url":"https://engineering.wingify.com/","name":"Free objects - a generalized interpreter pattern","alternateName":"Wingify Engineering - Blog","headline":"Free objects - a generalized interpreter pattern","image":{"@type":"ImageObject","url":""},"description":"In the GOF book, the interpreter pattern is probably one of the most poorly described patterns. The interpreter pattern basically consists…"}]</script><meta name="generator" content="Gatsby 2.22.11"/><link href="//fonts.googleapis.com/css?family=Neuton:700|Lato:400,400i,700" rel="stylesheet" type="text/css"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#c62828"/><link rel="apple-touch-icon" sizes="48x48" href="/images/favicon.png"/><link rel="alternate" type="application/rss+xml" title="/atom.xml" href="/atom.xml"/><link as="script" rel="preload" href="/framework-59a9ef51c55d9b62f7de.js"/><link as="script" rel="preload" href="/29107295-b32bd7b51275495551b1.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-64b7798af3e4c1e61db7.js"/><link as="script" rel="preload" href="/b1ea62611cf241fb890da72ef73a515c02a0750b-89441ba0b45d1db32094.js"/><link as="script" rel="preload" href="/app-2e9de3d453e820061555.js"/><link as="script" rel="preload" href="/styles-823ae8103e36ae8a7f9f.js"/><link as="script" rel="preload" href="/webpack-runtime-0957571b9c2c963ddd9b.js"/><link as="fetch" rel="preload" href="/page-data/posts/Free-objects/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header><h1><a href="/"><span class="Header-module--brand--nQIOf"><img src="https://wingify.com/wp-content/themes/wingify/images/labs/engg_blog.png" width="30px"/><span style="margin-top:5px;margin-left:15px">Wingify Engineering</span></span></a></h1><nav><ul class="Header-module--main-nav--2C0n8"><li><a href="/">Posts</a></li><li><a href="/labs">Labs</a></li><li><a href="/about">About</a></li><li><a href="https://github.com/wingify">Github</a></li><li><a href="/atom.xml">Feed</a></li></ul></nav></header><main><div><h1>Free objects - a generalized interpreter pattern</h1><img class="Bio-module--avatar--v_AB0" src="/images/team/chris_stucchio.png" alt="Chris Stucchio"/><p>Written by <strong>Chris Stucchio</strong> <div></div></p><p class="post-module--post-meta--1ci95">February 14, 2016<!-- --> — <!-- -->13<!-- --> Min Read<!-- --> <!-- --> |  <span class="disqus-comment-count" data-disqus-url="https://engineering.wingify.com/posts/Free-objects/">...</span></p><div><p>In the <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612">GOF book</a>, the <a href="https://en.wikipedia.org/wiki/Interpreter_pattern">interpreter pattern</a> is probably one of the most poorly described patterns. The interpreter pattern basically consists of building a specialty programming language out of objects in your language, and then interpreting it on the fly. <a href="https://en.wikipedia.org/wiki/Greenspun%27s_tenth_rule">Greenspun's Tenth Rule</a> describes it as follows:</p>
<blockquote>
<p>Any sufficiently complicated C or Fortran program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Common Lisp.</p>
</blockquote>
<p>In essence, the interpreter pattern consists of dynamically generating and transmitting code at run time instead of statically generating it at compile time.</p>
<p>However, I believe that modern functional programming provides us some alternatives that provide functionality approaching that of embedding a lisp interpreter in our runtime, but also with some measures of type safety. I'm going to describe Free Objects, and how they can be used as a substitute for an interpreter.</p>
<p>At Wingify, we have several important interpreters floating around in our (currently very experimental) event driven notification system. In this post I'll show how Free Boolean Algebras can drastically simplify the process of defining custom events.</p>
<h1 id="algebraic-structures" style="position:relative;"><a href="#algebraic-structures" aria-label="algebraic structures permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Algebraic structures</h1>
<p>In functional programming, there are a lot of algebraic structures that are used to write programs in a type-safe manner. <a href="https://blog.safaribooksonline.com/2013/05/15/monoids-for-programmers-a-scala-example/">Monoids</a> are one of the simplest examples - a monoid is a type <code class="language-text">T</code> together with an operation <code class="language-text">|+|</code> and an element <code class="language-text">zero[T]</code> with the following properties:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">a |+| (b |+| c) === (a |+| b) |+| c   //associativity
a |+| zero === a                      //zero</code></pre></div>
<p>A type is a monoid if it contains elements which can be added together in an associative way, together with a zero element. A number of common structures form monoids - integers (with <code class="language-text">a |+| b = a + b</code> ) are a simple example. For instance:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3 + (5 + 7) === (3 + 5) + 7 === 15
-17 + 0 === -17</code></pre></div>
<p>But many other data structures also obey this law. Lists and strings, using <code class="language-text">|+|</code> for concatenation and either <code class="language-text">[]</code> or <code class="language-text">&quot;&quot;</code> as the zero element, are also monoids. Monoids are commonly used as data structures to represent logs, for example.</p>
<p>Another algebraic structure is the Boolean Algebra. This is a type <code class="language-text">T</code> with three operations - <code class="language-text">&amp;</code>, <code class="language-text">|</code> and <code class="language-text">~</code>, with a rather larger set of properties:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">a &amp; (b &amp; c) === (a &amp; b) &amp; c
a | (b | c) === (a | b) | c
~~a === a
a &amp; (b | c) === (a &amp; b) | (a &amp; c)
a | (b &amp; c) === (a | b) &amp; (a | c)
a &amp; a === a
a | a === a
...etc...</code></pre></div>
<p>A boolean algebra also has both a <code class="language-text">zero</code> and <code class="language-text">one</code> element, satisfying <code class="language-text">zero &amp; _ === zero</code>, <code class="language-text">zero | x === x</code>, <code class="language-text">one &amp; x === x</code> and <code class="language-text">one | _ === one</code>. There are many common boolean algebras as well - <code class="language-text">Boolean</code> of course, but also fixed-length bitmaps (with operations interpreted bitwise), functions of type <code class="language-text">T =&gt; Boolean</code> (here <code class="language-text">f &amp; g = (x =&gt; f(x) &amp;&amp; g(x))</code>, etc).</p>
<p>There are quite a few more algebraic structures - monads provide another example. But I'm going to leave the trickier ones for another post.</p>
<h2 id="side-note-boolean-algebras-are-monoids-too" style="position:relative;"><a href="#side-note-boolean-algebras-are-monoids-too" aria-label="side note boolean algebras are monoids too permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Side note: Boolean Algebras are Monoids Too</h2>
<p>One of the interesting facts about abstract algebra is that many of these structures interact with each other in interesting ways. For example, any boolean algebra also has <em>two</em> monoids built into it. The operations <code class="language-text">&amp;</code> and <code class="language-text">one</code> satisfy the laws of a monoid:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">a &amp; (b &amp; c) === (a &amp; b) &amp; c
a &amp; one === a</code></pre></div>
<p>Similarly, the operations <code class="language-text">|</code> and <code class="language-text">zero</code> also satisfy the monoid laws:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">a | (b | c) === (a | b) | c
a | zero === a</code></pre></div>
<h1 id="event-predicates---take-one" style="position:relative;"><a href="#event-predicates---take-one" aria-label="event predicates   take one permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Event predicates - take one</h1>
<p>In our experimental (i.e., you can't use it yet) event based targeting system, I wanted to create an easy way for users to trigger events. I.e., I want to be able to define a formula and evaluate whether it is true or false for some event. E.g.:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">((EventType == &#39;pageview&#39;) &amp; (url == &#39;http://www.vwo.com/pricing/&#39;))
   | ((EventType == &#39;custom&#39;) &amp; (custom_event_name == &#39;pricing_popup_displayed&#39;))</code></pre></div>
<p>This can be represented in Scala pretty straightforwardly:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sealed trait EventPredicate {
  def matches(evt: Event): Boolean
  def &amp;(other: EventPredicate) = And(this, other)
  def |(other: EventPRedicate) = Or(this, other)
  ...
}
case class EventType(kind: String) extends EventPredicate {
  def matches(evt: Event) = EventLenses.eventType.get(evt) == kind
}</code></pre></div>
<p>We also need boolean operators:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">case class And(a: EventPredicate, b: EventPredicate) extends EventPredicate {
  def matches(evt: Event) = a.matches(evt) &amp;&amp; b.matches(evt)
}

...etc...</code></pre></div>
<p>Unfortunately, we have more than one type of predicate. We had quite a few requirements, in fact:</p>
<ol>
<li>We want to compile <em>some</em> predicates to Javascript so they can be evaluated browser side.</li>
<li>We want to define compound predicates for the convenience of the user. E.g. <code class="language-text">GACampaign(utm_source, utm_campaign, ...)</code> instead of <code class="language-text">URLParam(&quot;utm_source&quot;, &quot;email&quot;) &amp; URLParam(&quot;utm_campaign&quot;, &quot;ilovepuppies&quot;) &amp; ...</code>, but we'd also like to avoid re-implementing in multiple places things like parsing URL params.</li>
<li>We actually have multiple types of predicate - <code class="language-text">EventPredicate</code>, <code class="language-text">UserPredicate</code>, <code class="language-text">PagePredicate</code> and we'd like to avoid duplicating code to handle simple boolean algebra stuff. We'd also like to avoid namespace collisions, so we'd need to do <code class="language-text">AndEvent</code>, <code class="language-text">AndUser</code>, etc.</li>
<li>We also need to serialize these data structures to JSON, so it would be great if we could not duplicate code around things like serializing <code class="language-text">And___</code>, <code class="language-text">Or___</code>, etc.</li>
</ol>
<p>The simple object-oriented approach described above doesn't really satisfy all these requirements.</p>
<h1 id="the-free-boolean-algebra" style="position:relative;"><a href="#the-free-boolean-algebra" aria-label="the free boolean algebra permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Free Boolean Algebra</h1>
<p>Ultimately, what I really want to do is the following. I want to define a <em>set</em> of objects, e.g.:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">case class EventType(kind: String) extends EventSpec
case class URLMatch(url: String) extends EventSpec
...</code></pre></div>
<p>Then I want to be able to build a boolean algebra out of them with some sort of simple type constructor. Given
an object created with this type constructor, I then need to be able to make various algebra preserving transformations.</p>
<p>Luckily the field of abstract algebra provides a generic solution to this problem - the <a href="https://en.wikipedia.org/wiki/Free_object">Free Object</a>.
A free object is a version of an algebraic structure which has no interpretation whatsoever - it's a purely symbolic
way of representing that algebra. But the important thing about the free object is that it gives interpretation almost
for free.</p>
<p>More concretely, a Free Object is a <a href="http://eed3si9n.com/learning-scalaz/Functor.html">Functor</a> with a particular natural transformation. I.e., for any type <code class="language-text">T</code>, there is a type <code class="language-text">FreeObj[T]</code> with the following properties:</p>
<ol>
<li>For any object <code class="language-text">t</code> of type <code class="language-text">T</code>, there is a corresponding object <code class="language-text">t.point[FreeObj]</code> having type <code class="language-text">FreeObj[T]</code>. I.e., objects outside the functor can be lifted into it.</li>
<li>Let <code class="language-text">X</code> be another object having the same algebraic structure (e.g., <code class="language-text">X</code> is any boolean algebra). Then for any function <code class="language-text">f: T =&gt; X</code>, there is a natural transformation <code class="language-text">nat(f): FreeObj[T] =&gt; X</code> with the properties that (a) <code class="language-text">nat(f)(t.point) = f(t)</code> and (b) <code class="language-text">nat(f)</code> preserves the structure of the underlying algebra.</li>
</ol>
<p>Preserving the structure of the underlying algebra is important - this means that for a boolean algebra, <code class="language-text">nat(f)(x &amp; y) === nat(f)(x) &amp; nat(f)(y)</code>, <code class="language-text">nat(f)(x | y) === nat(f)(x) | nat(f)(y)</code>, etc.This property of preserving the structure is called <em>homomorphism</em>.</p>
<p>This bit of mathematics is, in programming terms, the API of our FreeObject. This API allows us to turn any type into a monoid/boolean algebra/etc, and it guarantees that no information whatsoever is lost by doing so.</p>
<h2 id="how-to-use-it" style="position:relative;"><a href="#how-to-use-it" aria-label="how to use it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to use it</h2>
<p>We've developed a library which includes Free Boolean Algebras called <a href="https://github.com/stucchio/oldmonk">Old Monk</a>. It's named after the <a href="https://en.wikipedia.org/wiki/Old_Monk">finest rum in the world</a>. Old Monk also builds on top of <a href="https://github.com/non/spire">Spire</a>, which provides various abstract algebra type classes in Scala.</p>
<p>To create a simple Boolean algebra for events, we import the following:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">import com.vwo.oldmonk.free._
implicit val freeBoolAlgebra = FreeBoolListAlgebra //There are multiple variants
type FreeBool = FreeBoolList
import spire.algebra._
import spire.implicits._</code></pre></div>
<p>We then define our underlying type:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sealed trait EventSpec
case class CookieValue(key: String, value: String) extends EventSpec
...</code></pre></div>
<p>Finally, we define the predicate type:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">type EventPredicate = FreeBool[EventSpec]</code></pre></div>
<p>Combining objects is now straightforward, and uses Spire syntax:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">val pred = CookieValue(&quot;foo&quot;, &quot;bar&quot;).point[FreeBool] | URLParam(&quot;_foo&quot;, &quot;bar&quot;)
val pred2 = ...
val pred3 = ~pred &amp; pred2</code></pre></div>
<p>(There is an implicit in oldmonk which is smart enough to turn the <code class="language-text">URLParam</code> object into an <code class="language-text">EventPredicate</code>, but not smart enough to apply to the first one.)</p>
<p>That's great - we've now got a boolean algebra. But how do we use it?</p>
<h3 id="evaluating-a-predicate" style="position:relative;"><a href="#evaluating-a-predicate" aria-label="evaluating a predicate permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Evaluating a predicate</h3>
<p>To evaluate a predicate, we need to use the <code class="language-text">nat</code> operation. Recall that the type of <code class="language-text">nat</code> is:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def nat[T,X](f: T =&gt; X): FreeBool[T] =&gt; X</code></pre></div>
<p>So to use this, we simply need to define how our function <code class="language-text">f</code> operates on <em>individual</em> <code class="language-text">EventSpec</code> objects:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def evalEventSpec(evt: Event): (EventSpec =&gt; Boolean) = (e:EventSpec) =&gt;
  e match {
    case CookieValue(k, v) =&gt; EventLenses.cookie(k).get(evt).getOrElse(false)
    case URLMatches(url) =&gt; EventLenses.url.get(evt) == url
    ...
  }</code></pre></div>
<p>Then by the magic of <code class="language-text">nat</code>, we can evaluate predicates:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def evaluateEventPredicate(pred: EventPredicate, event: Event): Boolean =
  nat(evalEventSpec(event))(pred)</code></pre></div>
<p>The logic is that <code class="language-text">evalEventSpec(event)</code> has type <code class="language-text">EventSpec =&gt; Boolean</code>. The operation <code class="language-text">nat</code> lifts this to
a function mapping <code class="language-text">EventPredicate =&gt; Boolean</code>, and then this function is applied to the actual predicate.</p>
<p>Due to the laws of the Free Boolean Algebra, we know that this method must evaluate things correctly. I.e.,
imagine we had a predicate <code class="language-text">a.point[FreeBool] | b.point[FreeBool]</code>.</p>
<p>By the second law of free Boolean algebras, the homomorphism property, we know that:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">nat(f)(a.point[FreeBool] | b.point[FreeBool]) ===
  nat(f)(a.point[FreeBool]) | nat(f)(b.point[FreeBool])</code></pre></div>
<p>By the first law, we know that:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">nat(f)(a.point[FreeBool]) === f(a)
nat(f)(b.point[FreeBool]) === f(b)</code></pre></div>
<p>Substituting this in yields:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">nat(f)(a.point[FreeBool] | b.point[FreeBool]) ===
  nat(f)(a.point[FreeBool]) | nat(f)(b.point[FreeBool]) ===
  f(a) | f(b)</code></pre></div>
<p>Thus, the <code class="language-text">nat</code> function has faithfully created a way for us to evaluate our predicates.</p>
<h3 id="translating-predicates" style="position:relative;"><a href="#translating-predicates" aria-label="translating predicates permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Translating predicates</h3>
<p>Consider one of our other requirements - we want to build convenience predicates for the user, but we don't want to duplicate work to evaluate them.</p>
<p>To handle this case, we'd tweak the underlying definition of our predicates a bit:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sealed trait EventSpec

sealed trait PrimitiveEventSpec extends EventSpec
case class CookieValue(key: String, value: String) extends PrimitiveEventSpec
...

sealed trait CompoundEventSpec extends EventSpec
case class GACampaignMatches(source: String,campaign: String)</code></pre></div>
<p>We'll approach this problem in two ways. First, we'll build a <em>translation</em> layer - a way to translate <code class="language-text">FreeBool[EventSpec] =&gt; FreeBool[PrimitiveEventSpec]</code>.
Then we'll build the <em>evaluation</em> layer - a way to compute <code class="language-text">FreeBool[PrimitiveEventSpec] =&gt; Boolean</code>. With this structure, we only need to
define evaluation on the primitives.</p>
<p>The translation is actually very simple with <code class="language-text">nat</code>. First we define a mapping from <code class="language-text">EventSpec =&gt; FreeBool[PrimitiveEventSpec]</code>, and then we use <code class="language-text">nat</code> to lift this function to <code class="language-text">FreeBool</code>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def primitivizeSpec(es: EventSpec): FreeBool[PrimitiveEventSpec]) = (es: EventSpec) match {
  case (x: PrimitiveEventSpec) =&gt; x.point[FreeBool]
  case (c: CompountEventSpec) =&gt; c match {
    case GACampaignMatches(source, campaign) =&gt;
      (URLParam(&quot;utm_source&quot;, source) : FreeBool[PrimitiveEventSpec]) &amp; (URLParam(&quot;utm_campaign&quot;, campaign) : FreeBool[PrimitiveEventSpec])
      ...
  }
}

val primitivize: FreeBool[EventSpec] =&gt; FreeBool[PrimitiveEventSpec] = nat(primitivizeSpec _)</code></pre></div>
<p>Then we would define evaluation the same as above:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def evalPrimitiveEventSpec(evt: Event): (EventSpec =&gt; Boolean) = (e:EventSpec) =&gt;
  e match {
    case CookieValue(k, v) =&gt; EventLenses.cookie(k).get(evt).getOrElse(false)
    case URLMatches(url) =&gt; EventLenses.url.get(evt) == url
    ...
  }

def evaluatePrimitiveEventPredicate(pred: PrimitiveEventPredicate, event: Event): Boolean =
  nat(evalPrimitiveEventSpec(event))(pred)</code></pre></div>
<p>Finally we would define evaluation as:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def evaluateEventPredicate(pred: EventPredicate, event: Event): Boolean =
  evaluatePrimitiveEventPredicate(primitivize(pred))</code></pre></div>
<h3 id="partial-evaluation" style="position:relative;"><a href="#partial-evaluation" aria-label="partial evaluation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Partial Evaluation</h3>
<p>Another cool trick this approach gives us is partial evaluation. Suppose we gain partial information about a predicate, but it's incomplete.
For instance, we know that <code class="language-text">evaluate(a)</code> should be <code class="language-text">True</code> but we don't know what <code class="language-text">evaluate(b)</code> should be.</p>
<p>Concretely, suppose we have a function:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def partialEvaluate(e: EventSpec): Option[Boolean] = ...</code></pre></div>
<p>We can then partially evaluate our predicates:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def partiallyEvaluatePredicate(e: EventPredicate) =
  nat( (e:EventSpec) =&gt; {
    partialEvaluate(e).fold( e )(x =&gt; {
      if (x) { True } else { False }
      })
    })</code></pre></div>
<p>Then, supposing we know <code class="language-text">a</code> to be true but <code class="language-text">b</code> is unknown, this will evaluate to:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">partiallyEvaluatePredicate(a &amp; b) ===
  partialEvaluate(a) &amp; partialEvaluate(b) ===
  True &amp; b ===
  b</code></pre></div>
<p>This is useful to us in a variety of cases. Often times we'll have a predicate which combines information known server
side, and other information which is only known in the browser. Partial evaluation lets us compute the server side information,
substitute this result in, and have a resulting predicate which depends only on browser-side information.</p>
<p>The browser-side predicate can then be rendered to javascript and evaluated in the browser directly. This is pretty straightforward, in fact:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def evaluateServerSide(e: ServerSideEventSpec): Boolean = ...

def browserify(e: EventPredicate): BrowserSideEventPredicate =
  nat( (e:EventSpec) =&gt; e match {
      case (b:BrowserSideEventSpec) =&gt; b.point[FreeBool] : BrowserSideEventPredicate
      case (s:ServerSideEventSpec) =&gt; if (evaluateServerSide(s)) {
         TruePred : BrowserSideEventPredicate
       } else {
         FalsePred : BrowserSideEventPredicate
       }
    }
  )</code></pre></div>
<h1 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>Free objects are a great way to build generalized interpreter patterns. Just as the <code class="language-text">FreeMonad</code> (called simply <code class="language-text">Free</code> in Scalaz) enables one to build generalized
stateful computations, abstracting away the actual state, <code class="language-text">FreeBool</code> allows us to build generalized predicates and manipulate them in a straightforward manner.</p>
<p>More generally, if you find yourself re-implementing the same algebraic structure over and over, it might be worth asking yourself if a free version of
that algebraic structure exists. If so, you might save yourself a lot of work by using that.</p>
<h1 id="other-free-objects" style="position:relative;"><a href="#other-free-objects" aria-label="other free objects permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other Free Objects</h1>
<p>One important free object is the <code class="language-text">FreeMonoid</code>. It turns out that the functor <code class="language-text">List[_]</code> is actually a Free Monoid. This can be shown by defining <code class="language-text">nat</code> for a list:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def nat[A,B](f: A=&gt;B)(implicit m: Monoid[B]): (List[A] =&gt; B) =
  (l: List[A]) =&gt; l.map(f).reduce((x,y) =&gt; m.append(x,y))</code></pre></div>
<p>Essentially, the natural transformation consists of taking each element of the list, applying the function <code class="language-text">f</code> to it, and then appending the elements.</p>
<p>A somewhat more interesting free algebra is the <code class="language-text">FreeGroup</code>. A <code class="language-text">Group</code> is a <code class="language-text">Monoid</code>, but with an additional operation - inversion. Inversion - denoted by <code class="language-text">~x</code> - has the important property that for any <code class="language-text">x</code>, <code class="language-text">(~x) |+| x = zero</code> and <code class="language-text">x |+| (~x) = zero</code>. I.e., appending two elements together can always be undone by appending a new element.</p>
<p>For an example of a group, consider the integers - <code class="language-text">x |+| y = x + y</code>, and <code class="language-text">~x = -x</code>.</p>
<p>The type <code class="language-text">FreeGroup[A] then consists essentially of a</code>List[A]<code class="language-text">, with the caveat that</code>a<code class="language-text">and</code>~a` cannot occur adjacent to each other in the list.</p>
<p>Similarly, a <code class="language-text">FreeMonad</code> is a way of taking any <code class="language-text">Functor</code> and getting an abstract monad out of it. This is implemented <a href="https://github.com/scalaz/scalaz/blob/series/7.2.x/core/src/main/scala/scalaz/Free.scala">in scalaz</a>, so the naming is a little different. Given an object <code class="language-text">x: Free[S,A]</code> (for <code class="language-text">S[_]</code> a <code class="language-text">Functor</code>), <code class="language-text">x</code> has the method <code class="language-text">foldMap[M[_]](f: S ~&gt; M)(implicit M: Monad[M]): M[A]</code>. This method implements the natural transformation. In the language we are using here, we could define <code class="language-text">nat</code> as follows:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">def nat[S,M,A](f: S[A] =&gt; M[A])(implicit m: Monad[M]): (Free[S,A] =&gt; M[A]) =
  (x:Free[S,A]) =&gt; x.foldMap(f)(m)</code></pre></div>
<p>As an illustrated example of how free monads work, <a href="http://polygonalhell.blogspot.com/2014/12/scalaz-getting-to-grips-free-monad.html">this article</a> discusses how to represent a Forth-like DSL with the <code class="language-text">FreeMonad</code> and then interpret it via a mapping from <code class="language-text">Free =&gt; State</code>.</p>
<p><a href="http://eed3si9n.com/learning-scalaz/Free+Monad.html">Free Monad</a>.
<a href="http://underscore.io/blog/posts/2015/04/14/free-monads-are-simple.html">Free Monads are Simple</a>
<a href="http://underscore.io/blog/posts/2015/04/23/deriving-the-free-monad.html">Deriving the Free Monad</a></p></div><hr/><div class="post-module--post-meta--1ci95"><div class="SocialLinks-module--social-links--1RDpJ"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--reddit"><div style="width:32px;height:32px"><svg viewBox="0 0 64 64" width="32" height="32" class="social-icon social-icon--reddit "><g><circle cx="32" cy="32" r="31" fill="#5f99cf"></circle></g><g><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></g></svg></div><div class="SocialMediaShareCount"><div class="SocialLinks-module--share-count--3wXKp"></div></div></div><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter"><div style="width:32px;height:32px"><svg viewBox="0 0 64 64" width="32" height="32" class="social-icon social-icon--twitter "><g><circle cx="32" cy="32" r="31" fill="#00aced"></circle></g><g><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></g></svg></div></div><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook"><div style="width:32px;height:32px"><svg viewBox="0 0 64 64" width="32" height="32" class="social-icon social-icon--facebook "><g><circle cx="32" cy="32" r="31" fill="#3b5998"></circle></g><g><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></g></svg></div><div class="SocialMediaShareCount"><div class="SocialLinks-module--share-count--3wXKp"></div></div></div><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin"><div style="width:32px;height:32px"><svg viewBox="0 0 64 64" width="32" height="32" class="social-icon social-icon--linkedin "><g><circle cx="32" cy="32" r="31" fill="#007fb1"></circle></g><g><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></g></svg></div><div class="SocialMediaShareCount"><div class="SocialLinks-module--share-count--3wXKp"></div></div></div><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--telegram"><div style="width:32px;height:32px"><svg viewBox="0 0 64 64" width="32" height="32" class="social-icon social-icon--telegram "><g><circle cx="32" cy="32" r="31" fill="#37aee2"></circle></g><g><path d="m45.90873,15.44335c-0.6901,-0.0281 -1.37668,0.14048 -1.96142,0.41265c-0.84989,0.32661 -8.63939,3.33986 -16.5237,6.39174c-3.9685,1.53296 -7.93349,3.06593 -10.98537,4.24067c-3.05012,1.1765 -5.34694,2.05098 -5.4681,2.09312c-0.80775,0.28096 -1.89996,0.63566 -2.82712,1.72788c-0.23354,0.27218 -0.46884,0.62161 -0.58825,1.10275c-0.11941,0.48114 -0.06673,1.09222 0.16682,1.5716c0.46533,0.96052 1.25376,1.35737 2.18443,1.71383c3.09051,0.99037 6.28638,1.93508 8.93263,2.8236c0.97632,3.44171 1.91401,6.89571 2.84116,10.34268c0.30554,0.69185 0.97105,0.94823 1.65764,0.95525l-0.00351,0.03512c0,0 0.53908,0.05268 1.06412,-0.07375c0.52679,-0.12292 1.18879,-0.42846 1.79109,-0.99212c0.662,-0.62161 2.45836,-2.38812 3.47683,-3.38552l7.6736,5.66477l0.06146,0.03512c0,0 0.84989,0.59703 2.09312,0.68132c0.62161,0.04214 1.4399,-0.07726 2.14229,-0.59176c0.70766,-0.51626 1.1765,-1.34683 1.396,-2.29506c0.65673,-2.86224 5.00979,-23.57745 5.75257,-27.00686l-0.02107,0.08077c0.51977,-1.93157 0.32837,-3.70159 -0.87096,-4.74991c-0.60054,-0.52152 -1.2924,-0.7498 -1.98425,-0.77965l0,0.00176zm-0.2072,3.29069c0.04741,0.0439 0.0439,0.0439 0.00351,0.04741c-0.01229,-0.00351 0.14048,0.2072 -0.15804,1.32576l-0.01229,0.04214l-0.00878,0.03863c-0.75858,3.50668 -5.15554,24.40802 -5.74203,26.96472c-0.08077,0.34417 -0.11414,0.31959 -0.09482,0.29852c-0.1756,-0.02634 -0.50045,-0.16506 -0.52679,-0.1756l-13.13468,-9.70175c4.4988,-4.33199 9.09945,-8.25307 13.744,-12.43229c0.8218,-0.41265 0.68483,-1.68573 -0.29852,-1.70681c-1.04305,0.24584 -1.92279,0.99564 -2.8798,1.47502c-5.49971,3.2626 -11.11882,6.13186 -16.55882,9.49279c-2.792,-0.97105 -5.57873,-1.77704 -8.15298,-2.57601c2.2336,-0.89555 4.00889,-1.55579 5.75608,-2.23009c3.05188,-1.1765 7.01687,-2.7042 10.98537,-4.24067c7.94051,-3.06944 15.92667,-6.16346 16.62028,-6.43037l0.05619,-0.02283l0.05268,-0.02283c0.19316,-0.0878 0.30378,-0.09658 0.35471,-0.10009c0,0 -0.01756,-0.05795 -0.00351,-0.04566l-0.00176,0zm-20.91715,22.0638l2.16687,1.60145c-0.93418,0.91311 -1.81743,1.77353 -2.45485,2.38812l0.28798,-3.98957" fill="white"></path></g></svg></div></div></div></div></div><nav><ul class="post-module--pagination--1F-V0"><li><a rel="prev" href="/posts/layout-trick/">← <!-- -->A layout trick</a></li><li><a rel="next" href="/posts/superlelasticsearch/">SuperElasticsearch - More Python goodness in elasticsearch-py<!-- -->→</a></li></ul></nav><div id="disqus_thread"></div></main><footer><div class="Footer-module--container--3Dvn1"><div><a href="https://twitter.com/wingify_engg" target="_blank" rel="noopener noreferrer">Twitter</a><a href="https://github.com/wingify" target="_blank" rel="noopener noreferrer">GitHub</a><a href="https://engineering.wingify.com/atom.xml" target="_blank" rel="noopener noreferrer">RSS</a></div><div class="Footer-module--copyright--2uglW">Copyright © Wingify. All rights reserved.</div></div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-36431088-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/Free-objects/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-2e9de3d453e820061555.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-e385def15e29b6ed02a7.js"],"component---src-pages-404-js":["/component---src-pages-404-js-0c6355b7aa7c186b82f7.js"],"component---src-pages-about-js":["/component---src-pages-about-js-94e87d307d822d34146e.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-8f1d647515267d9174b5.js"],"component---src-pages-index-js":["/component---src-pages-index-js-00bc51841b217a16cffb.js"],"component---src-pages-labs-js":["/component---src-pages-labs-js-f0c81fd897adac009df3.js"],"component---src-templates-post-js":["/component---src-templates-post-js-64b7798af3e4c1e61db7.js"]};/*]]>*/</script><script src="/webpack-runtime-0957571b9c2c963ddd9b.js" async=""></script><script src="/styles-823ae8103e36ae8a7f9f.js" async=""></script><script src="/app-2e9de3d453e820061555.js" async=""></script><script src="/b1ea62611cf241fb890da72ef73a515c02a0750b-89441ba0b45d1db32094.js" async=""></script><script src="/component---src-templates-post-js-64b7798af3e4c1e61db7.js" async=""></script><script src="/29107295-b32bd7b51275495551b1.js" async=""></script><script src="/framework-59a9ef51c55d9b62f7de.js" async=""></script></body></html>